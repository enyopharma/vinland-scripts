#!/usr/bin/env perl
use strict;
use warnings;
use DBI;
use Data::Dumper;

my $source = shift @ARGV or die('no source');

my $cnx = DBI->connect(
    sprintf('DBI:Pg:database=%s;host=%s', 'vinland', $ENV{'DB_HOSTNAME'}),
    $ENV{'DB_USERNAME'},
    $ENV{'DB_PASSWORD'},
);

my @annotations = ();

while (my $line = <>) {
    chomp $line;

    my @parts = split("\t", $line);

    my $ref = shift @parts;
    my $name = shift @parts;

    push(@annotations, [
        $source,
        $ref,
        $name,
        sprintf('%s %s', $ref, $name),
        '{' . join(',', @parts) . '}',
    ]);
}

$cnx->do('COPY annotations (source, ref, name, search, accessions) FROM STDIN');

$cnx->pg_putcopydata(join("\t", @{$_}) . "\n") foreach (@annotations);

$cnx->pg_putcopyend();
